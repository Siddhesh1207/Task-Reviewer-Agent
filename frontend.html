<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Reviewer Agent</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #4a90e2; --primary-hover: #357bd9; --accent-teal: #1abc9c;
            --background-light: #f4f6f9; --background-gradient: linear-gradient(135deg, #eef2f7 0%, #d8e3ed 100%);
            --text-dark: #1f2937; --text-light: #6b7280; --border-color: #d1d5db; --card-bg: #ffffff;
            --card-shadow-light: 0 4px 15px rgba(0, 0, 0, 0.05); --card-shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.1);
            --code-bg: #f3f4f6;
        }
        body { font-family: 'Inter', sans-serif; background: var(--background-gradient); margin: 0; padding: 2rem; color: var(--text-dark); }
        .container { max-width: 900px; margin: auto; background: linear-gradient(135deg, #fdfefe, #f1f5f9); padding: 2.5rem; border-radius: 18px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05); }
        h1 { text-align: center; font-size: 2.5rem; margin-bottom: 2rem; font-weight: 700; }
        .page { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .page.active { display: block; opacity: 1; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
        .card { background: var(--background-light); border-radius: 14px; padding: 2rem; text-align: center; box-shadow: var(--card-shadow-light); border: 1px solid var(--border-color); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
        .card:hover { transform: translateY(-7px); box-shadow: var(--card-shadow-hover); }
        .card h2 { margin-bottom: 0.75rem; color: var(--primary-blue); }
        .form-section { background: linear-gradient(145deg, #f0f9ff, #e0f2fe); border-radius: 18px; padding: 2rem 2.5rem; margin-top: 2rem; border: 1px solid #bfdbfe; box-shadow: 0 8px 24px rgba(74, 144, 226, 0.15); }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
        input, textarea { box-sizing: border-box; width: 100%; padding: 0.85rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; }
        input:focus, textarea:focus { border-color: var(--primary-blue); box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.2); outline: none; }
        textarea { height: 120px; resize: vertical; }
        .button-group { display: flex; gap: 1rem; align-items: center; }
        button { background: var(--primary-blue); color: white; border: none; padding: 0.95rem 1.8rem; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background 0.2s, transform 0.1s, box-shadow 0.2s; box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2); }
        button:hover { background: var(--primary-hover); box-shadow: 0 6px 15px rgba(53, 123, 217, 0.3); }
        button:disabled { background: #9ca3af; cursor: not-allowed; box-shadow: none; }
        .back-btn { background: #6b7280; box-shadow: none; }
        .result-card { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden; box-shadow: var(--card-shadow-light); }
        .card-header { padding: 0.75rem 1.25rem; font-weight: 600; color: white; display: flex; align-items: center; gap: 0.5rem; }
        .score-header { background: #16a34a; } .feedback-header { background: #f59e0b; } .nexttask-header { background: #4a90e2; }
        .card-body { padding: 1.25rem; font-size: 0.95rem; background: var(--code-bg); font-family: 'JetBrains Mono', monospace; white-space: pre-wrap; word-wrap: break-word; }
        .spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status { padding: 1rem; text-align: center; font-weight: bold; border-radius: 8px; margin-top: 1rem; }
        .success { background-color: #dcfce7; color: #166534; } .error { background-color: #fee2e2; color: #991b1b; }
        .feedback-section { text-align: center; background: #fff; padding: 1.5rem; border-radius: 12px; margin-top: 2rem; border: 1px solid var(--border-color); }
        .feedback-section button { font-size: 1.5rem; padding: 0.5rem 1rem; background: none; border: none; cursor: pointer; transition: transform 0.2s; }
        .feedback-section button:hover { transform: scale(1.2); }
        /* <-- NEW: Style for the generate next task button --> */
        #generate-next-task-btn { background: var(--accent-teal); }
        #generate-next-task-btn:hover { background: #16a085; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Task Reviewer Agent</h1>
        <div class="page active" id="home-page">
            <div class="card-grid">
                <div class="card" onclick="showPage('create-task-page')"><h2>üöÄ Start Here: Create a New Task</h2><p>First, define a task and save it to the database.</p></div>
            </div>
        </div>
        <div class="page form-section" id="create-task-page">
            <h2>1. Create a New Task</h2>
            <form id="create-task-form">
                <label for="task-id">Task ID:</label><input type="text" id="task-id" value="task-001" required>
                <label for="task-title">Title:</label><input type="text" id="task-title" value="Create a basic Python function" required>
                <label for="task-description">Description:</label><textarea id="task-description" required>Write a Python function that takes two numbers and returns their sum.</textarea>
                <div class="button-group"><button type="submit">Create and Proceed</button><div class="spinner" id="spinner-create"></div></div>
            </form>
            <div id="create-status"></div>
            <button class="back-btn" onclick="goHome()">‚¨Ö Back to Home</button>
        </div>
        <div class="page" id="review-options-page">
              <h2>2. Choose Review Method</h2>
              <div class="card-grid">
                <div class="card" onclick="showPage('text-review')"><h2>‚úçÔ∏è Review via Text</h2><p>Submit your task solution directly as text.</p></div>
                <div class="card" onclick="showPage('file-review')"><h2>üìÇ Review via File Upload</h2><p>Upload a file for review.</p></div>
              </div>
              <button class="back-btn" onclick="showPage('create-task-page')">‚¨Ö Back to Create Task</button>
        </div>
        <div class="page form-section" id="text-review">
            <h2>Submit via Text</h2>
            <form id="review-form-text">
                <label for="review-task-id-text">Task ID:</label><input type="text" id="review-task-id-text" readonly>
                <label for="submission-text">Submission Text:</label><textarea id="submission-text" required>def add(a, b): return a + b</textarea>
                <div class="button-group"><button type="submit">Run Review</button><div class="spinner" id="spinner-text"></div></div>
            </form>
            <button class="back-btn" onclick="showPage('review-options-page')">‚¨Ö Back</button>
        </div>
        <div class="page form-section" id="file-review">
            <h2>Submit via File Upload</h2>
            <form id="review-form-file">
                <label for="review-task-id-file">Task ID:</label><input type="text" id="review-task-id-file" readonly>
                <label for="submission-file">Submission File:</label><input type="file" id="submission-file" required>
                <div class="button-group"><button type="submit">Run Review</button><div class="spinner" id="spinner-file"></div></div>
            </form>
            <button class="back-btn" onclick="showPage('review-options-page')">‚¨Ö Back</button>
        </div>
        
        <div class="page results-section" id="results-container">
            <h2>Review Results</h2>
            <div class="result-card"><div class="card-header score-header">‚úÖ Review Score</div><pre class="card-body" id="review-output"></pre></div>
            <div class="result-card"><div class="card-header feedback-header">üí° Feedback Note</div><pre class="card-body" id="note-output"></pre></div>
            
            <div class="result-card" id="next-task-card" style="display: none;">
                <div class="card-header nexttask-header">üìå Suggested Next Task</div>
                <pre class="card-body" id="next-task-output"></pre>
            </div>

            <div class="feedback-section" id="feedback-section">
                <h3>Was this review helpful?</h3>
                <button id="thumb-up-btn">üëç</button>
                <button id="thumb-down-btn">üëé</button>
                <div id="feedback-status" style="margin-top: 1rem;"></div>
            </div>

            <div class="button-group" style="justify-content: center; margin-top: 1rem;">
                <button id="generate-next-task-btn" style="display: none;">Generate Next Task</button>
                <div class="spinner" id="spinner-next-task" style="display: none;"></div>
            </div>
            
            <button class="back-btn" id="finish-btn" onclick="goHome()">üéâ Finish & Start Over</button>
        </div>
    </div>

    <script>
        const API_BASE_URL = "http://127.0.0.1:8000";
        const API_KEY = ""; // <-- üö® IMPORTANT: REPLACE WITH YOUR KEY FROM .env
        const HEADERS = { 'Content-Type': 'application/json', 'X-API-Key': API_KEY };

        let currentReviewId = null; 

        const createTaskForm = document.getElementById('create-task-form');
        const reviewFormText = document.getElementById('review-form-text');
        const reviewFormFile = document.getElementById('review-form-file');
        const thumbUpBtn = document.getElementById('thumb-up-btn');
        const thumbDownBtn = document.getElementById('thumb-down-btn');
        // <-- NEW: Get the new button -->
        const generateNextTaskBtn = document.getElementById('generate-next-task-btn');

        function showPage(pageId) {
            document.querySelectorAll(".page").forEach(el => el.classList.remove("active"));
            document.getElementById(pageId).classList.add("active");
        }
        function goHome() { location.reload(); }

        createTaskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const taskId = document.getElementById('task-id').value;
            const spinner = document.getElementById('spinner-create');
            const submitButton = createTaskForm.querySelector('button[type="submit"]');
            const statusDiv = document.getElementById('create-status');

            spinner.style.display = 'block'; submitButton.disabled = true; statusDiv.innerHTML = '';
            try {
                const response = await fetch(`${API_BASE_URL}/tasks`, {
                    method: 'POST', headers: HEADERS,
                    body: JSON.stringify({ task_id: taskId, title: document.getElementById('task-title').value, description: document.getElementById('task-description').value })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Failed to create task');
                document.getElementById('review-task-id-text').value = taskId;
                document.getElementById('review-task-id-file').value = taskId;
                showPage('review-options-page');
            } catch (error) {
                statusDiv.className = 'status error'; statusDiv.textContent = `Error: ${error.message}`;
            } finally {
                spinner.style.display = 'none'; submitButton.disabled = false;
            }
        });

        // <-- MODIFIED: This function only displays the initial review and resets the UI -->
        function displayResults(result) {
            currentReviewId = result.review_id; 
            document.getElementById('review-output').textContent = JSON.stringify(result.review, null, 2);
            document.getElementById('note-output').textContent = result.feedback_note.note;
            
            // Reset the UI state for a new review
            document.getElementById('feedback-section').style.display = 'block';
            document.getElementById('next-task-card').style.display = 'none';
            generateNextTaskBtn.style.display = 'none';
            thumbUpBtn.disabled = false;
            thumbDownBtn.disabled = false;
            document.getElementById('feedback-status').innerHTML = '';

            showPage('results-container');
        }

        async function handleReview(form, spinner) {
            spinner.style.display = 'block'; form.querySelector('button[type="submit"]').disabled = true;
            try {
                let response;
                if (form.id === 'review-form-text') {
                    const taskId = document.getElementById('review-task-id-text').value;
                    const submissionText = document.getElementById('submission-text').value;
                    response = await fetch(`${API_BASE_URL}/full-review-text/${taskId}`, { method: 'POST', headers: HEADERS, body: JSON.stringify({ submission_text: submissionText }) });
                } else {
                    const taskId = document.getElementById('review-task-id-file').value;
                    const formData = new FormData();
                    formData.append('submission_file', document.getElementById('submission-file').files[0]);
                    response = await fetch(`${API_BASE_URL}/full-review-file/${taskId}`, { method: 'POST', headers: { 'X-API-Key': API_KEY }, body: formData });
                }
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'An unknown error occurred.');
                displayResults(result);
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                spinner.style.display = 'none'; form.querySelector('button[type="submit"]').disabled = false;
            }
        }
        
        // <-- MODIFIED: This function now contains the conditional logic -->
        async function sendFeedback(sentiment) {
            if (!currentReviewId) return;
            const statusDiv = document.getElementById('feedback-status');
            statusDiv.className = 'status';
            statusDiv.textContent = 'Sending feedback...';
            thumbUpBtn.disabled = true; thumbDownBtn.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE_URL}/feedback/${currentReviewId}`, {
                    method: 'POST', headers: HEADERS,
                    body: JSON.stringify({ sentiment: sentiment })
                });
                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.detail || 'Failed to send feedback.');
                }

                document.getElementById('feedback-section').style.display = 'none';

                if (sentiment === 'up') {
                    generateNextTaskBtn.style.display = 'block'; // Show the "Generate" button
                } else { // sentiment === 'down'
                    statusDiv.className = 'status';
                    statusDiv.textContent = `Thank you for the feedback. Please consider revising your task and trying again.`;
                }

            } catch (error) {
                statusDiv.className = 'status error'; statusDiv.textContent = `Error: ${error.message}`;
                thumbUpBtn.disabled = false; thumbDownBtn.disabled = false;
            }
        }

        // <-- NEW: This function calls the new endpoint -->
        async function generateNextTask() {
            if (!currentReviewId) return;
            const spinner = document.getElementById('spinner-next-task');
            spinner.style.display = 'block';
            generateNextTaskBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/generate-next-task/${currentReviewId}`, {
                    method: 'POST',
                    headers: { 'X-API-Key': API_KEY }
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Failed to generate next task.');

                document.getElementById('next-task-output').textContent = JSON.stringify(result.next_task, null, 2);
                document.getElementById('next-task-card').style.display = 'block';
                generateNextTaskBtn.style.display = 'none'; 

            } catch (error) {
                alert(`Error generating next task: ${error.message}`);
                generateNextTaskBtn.disabled = false;
            } finally {
                spinner.style.display = 'none';
            }
        }

        reviewFormText.addEventListener('submit', (e) => { e.preventDefault(); handleReview(reviewFormText, document.getElementById('spinner-text')); });
        reviewFormFile.addEventListener('submit', (e) => { e.preventDefault(); handleReview(reviewFormFile, document.getElementById('spinner-file')); });
        thumbUpBtn.addEventListener('click', () => sendFeedback('up'));
        thumbDownBtn.addEventListener('click', () => sendFeedback('down'));
        generateNextTaskBtn.addEventListener('click', generateNextTask);
    </script>
</body>
</html>
